"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tableinfo_1=require("./tableinfo"),dbutil_1=require("./dbutil"),query_1=require("./query"),dbqueue_1=require("./dbqueue"),mysql=require("mysql"),db=function(){function t(){this._0=new dbqueue_1.dbqueue,this._1=new dbqueue_1.dbqueue,this.tables={},this.escape=mysql.escape,this.q=new query_1.query}return t.prototype.destroy=function(){this.pool.end()},t.prototype.size=function(){return this._0.size()+this._1.size()},t.prototype.connect=function(r,t,e,o){void 0===o&&(o=null);var _=this;if(null==_.name){"object"!=typeof t&&(t={host:"localhost",port:3306,user:"root",password:"",database:t,charset:"UTF8_GENERAL_CI"});Date.now();var n=t.database,i=mysql.createPoolCluster();i.add(n,t),_.pool=i,_.conn=i.of(n),_.name=n;_._add(_._0,_,_.q._sql,[null,null,"show tables"],function(t,e){if(t)r(t);else{var u="Tables_in_"+n,l=e.length;e.forEach(function(t){var n=t[u],i=new tableinfo_1.tableinfo;_.tables[n]=i;var e=[null,null,"show full columns from "+n];0,_._add(_._0,_,_.q._sql,e,function(t,e){l--,dbutil_1.dbutil.isKeyPRI(e[0])||o(n+" keypri is not "+e[0].field),i.setInfo(_,n,e),o&&o("read table : "+i.tableName),0==l&&r(null)})})}})}else r("It has already connect!")},t.prototype._add=function(t,e,u,l,r){t.add(function(i){e.getConnection(function(t,n){t?(r&&r(t,null),i()):(l[0]=function(t,e){n.release(),r&&r(t,e),i()},l[1]=n,u.apply(null,l))})})},t.prototype.find=function(t,e,n){var i=this,u=i._check(t,n,e,i);null!=u&&i._add(i._0,i,i.q._find.bind(i.q),[null,null,n,u],t)},t.prototype.findMax=function(t,e,n,i,u){void 0===i&&(i=null),void 0===u&&(u=0);var l=this,r=l.tables[e];null!=r?l._add(l._0,l,l.q._findMax.bind(l.q),[null,null,r,n,i,u],t):t(l.name+" has no table with name="+e,null)},t.prototype.update=function(t,e){if(e.__1!=dbutil_1.dbutil.SELECT)return!1;var n=this;return e.__1=dbutil_1.dbutil.UPDATE,n._add(n._1,n,n.q._update.bind(n.q),[null,null,e],t),!0},t.prototype.insert=function(t,e){if(e.__1!=dbutil_1.dbutil.INIT)return!1;e.__1=dbutil_1.dbutil.INSERT;var n=this;return n._add(n._1,n,n.q._insert.bind(n.q),[null,null,e],t),!0},t.prototype.delete=function(t,e){var n=e.__1;if(n==dbutil_1.dbutil.INIT)return!1;if(n==dbutil_1.dbutil.INSERT)e.__1=dbutil_1.dbutil.INIT;else if(n!=dbutil_1.dbutil.DELETE){var i=this;return e.__1=dbutil_1.dbutil.DELETE,i._add(i._1,i,i.q._delete.bind(i.q),[null,null,e],t),!0}return!1},t.prototype.deleteId=function(t,e,n){var i=this,u=i._check(t,e,n,i);null!=u&&i._add(i._1,i,i.q._sql.bind(i.q),[null,null,u.delete+e,null],t)},t.prototype.sql=function(t,e,n){var i=this;i._add(i._0,i,i.q._sql.bind(i.q),[null,null,e,n],t)},t.prototype.getConnection=function(t){return this.conn.getConnection(t)},t.prototype.table=function(t){return this.tables[t]},t.prototype.newRow=function(t,e){var n=this.tables[t];return null!=n&&dbutil_1.dbutil.newRow(n,e),e},t.prototype.allTables=function(){return this.tables},t.prototype._check=function(t,e,n,i){if(isNaN(e))return t("id must be number "+e,null),null;var u=i.tables[n];return null==u?(t("DB:"+i.name+" do not have a table="+n,null),null):u},t}();exports.db=db,Object.defineProperty(exports,"__esModule",{value:!0});var dbqueue=function(){function t(){this.count=1,this._a=[],this._0=0}return t.prototype.add=function(t){var e=this._a;e[e.length]=t,this._next()},t.prototype._endcb=function(){var t=this._a,e=this._0;0<t.length?(t.splice(0,1),this._0=e-1,this._next()):console.error("it must no happed!")},t.prototype._next=function(){var t=this,e=t._a,n=t._0;0<e.length&&n<t.count&&(t._0=n+1,e[n](t._endcb.bind(t)))},t.prototype.size=function(){return this._a.length},t}();exports.dbqueue=dbqueue,Object.defineProperty(exports,"__esModule",{value:!0});var dbutil=function(){function r(){}return r.isKeyPRI=function(t){return"PRI"==t.Key},r.getid=function(t){return t.__0.getid(t)},r.getDefault=function(t){var e=t.Extra;return"auto_increment"==e?0:null!=(e=t.Default)?e:0==(e=t.Type).indexOf("int")?0:0==e.indexOf("date")?new Date:null},r.hasData=function(t){return t.__1!=r.INIT},r.newRow=function(t,e){(e=e||{}).__0=t,e.__1=r.INIT;for(var n=t.field_db,i=t.fieldNames,u=0;u<n.length;u++){var l=i[u];null==e[l]&&(e[l]=r.getDefault(t.field_db[u]))}return e},r.setRow=function(t,e,n){t.__0=n,t.__1=e},r.cloneRow=function(t){var e={};for(var n in t)e[n]=t[n];return e},r.cloneRow2obj=function(t){var e={};for(var n in t)"__0"!=n&&"__1"!=n&&(e[n]=t[n]);return e},r.result2Row=function(t,e){return t.__0=e,t.__1=r.SELECT,t},r.stringify=function(t,e){return void 0===e&&(e=0),JSON.stringify(t,t.__0.fieldNames,e)},r.INIT=0,r.INSERT=1,r.SELECT=2,r.UPDATE=3,r.DELETE=4,r}();exports.dbutil=dbutil,Object.defineProperty(exports,"__esModule",{value:!0});dbutil_1=require("./dbutil");var query=function(){function t(){}return t.prototype._sql=function(t,e,n,i){e.query(n,i,t)},t.prototype._update=function(t,e,n){if(n.__1==dbutil_1.dbutil.UPDATE){var i=n.__0;this._sql(t,e,i.update+i.getid(n),i.p_update(n))}else t(n.__1+"!=update",n)},t.prototype._delete=function(t,e,n){if(n.__1==dbutil_1.dbutil.DELETE){var i=n.__0;this._sql(t,e,n.__0.delete+i.getid(n),null)}else t(n.__1+"!=delete",n)},t.prototype._insert=function(n,t,i){if(i.__1==dbutil_1.dbutil.INSERT){var u=i.__0;this._sql(function(t,e){t||(i[u.keyName]=e.insertId,i.__1=dbutil_1.dbutil.SELECT),n(t,e)},t,u.insert,u.p_insert(i))}else n(i.__1+"!=insert",i)},t.prototype._select=function(i,t,u,e,l){this._sql(function(t,e){if(t)i(t,u);else{for(var n=0;n<e.length;n++)dbutil_1.dbutil.result2Row(e[n],l);i(t,e)}},t,u,e)},t.prototype._find=function(t,e,n,i){this._select(t,e,i.select+n,null,i)},t.prototype._findMax=function(t,e,n,i,u,l){var r=n.s_select(i,u,l),o=n.a_select(i);this._select(t,e,r,o,n)},t}();exports.query=query,Object.defineProperty(exports,"__esModule",{value:!0});var tableinfo=function(){function t(){}return t.prototype.setInfo=function(t,e,n){for(var i=[],u=[],l=0;l<n.length;l++)i[l]=n[l].Field,u[l]=n[l].Comment;var r=n[0].Field,o=this;o.keyName=r,o.fieldNames=i,o.fieldComments=u,o.field_db=n,o.tableName=e,o.select="select * from "+e+" where "+r+"=",o.delete="delete from "+e+" where "+r+"=";var _=i[1]+"=?";for(l=2;l<i.length;l++)_=_+","+i[l]+"=?";o.insert="insert into "+e+" set "+_,o.update="update "+e+" set "+_+" where "+r+"="},t.prototype.getid=function(t){return t[this.keyName]},t.prototype.setid=function(t,e){t[this.keyName]=e},t.prototype.p_insert=function(t){return this.p_update(t)},t.prototype.p_update=function(t){for(var e=this.fieldNames,n=[],i=e.length-1;0<i;i--)n[i-1]=t[e[i]];return n},t.prototype.s_select=function(t,e,n){var i="select * from "+this.tableName;if(t){i+=" where ";for(var u=0;u<t.length;u++){0<u&&(i+=" and ");var l=t[u];i=i+"("+l[0]+" "+l[1]+" ?)"}}return e&&(i=i+" order by "+e),n&&0<n&&(i=i+" limit "+n),i},t.prototype.a_select=function(t){var e=[];if(t)for(var n=0;n<t.length;n++)e[n]=t[n][2];return e},t}();exports.tableinfo=tableinfo;