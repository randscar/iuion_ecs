define("dbutil",["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function u(){}return u.isKeyPRI=function(e){return"PRI"==e.Key},u.getid=function(e){return e.__0.getid(e)},u.getDefault=function(e){var t=e.Extra;return"auto_increment"==t?0:null!=(t=e.Default)?t:0==(t=e.Type).indexOf("int")?0:0==t.indexOf("date")?new Date:null},u.hasData=function(e){return e.__1!=u.INIT},u.newRow=function(e,t){(t=t||{}).__0=e,t.__1=u.INIT;for(var n=e.field_db,i=e.fieldNames,r=0;r<n.length;r++){var o=i[r];null==t[o]&&(t[o]=u.getDefault(e.field_db[r]))}return t},u.setRow=function(e,t,n){e.__0=n,e.__1=t},u.cloneRow=function(e){var t={};for(var n in e)t[n]=e[n];return t},u.cloneRow2obj=function(e){var t={};for(var n in e)"__0"!=n&&"__1"!=n&&(t[n]=e[n]);return t},u.result2Row=function(e,t){return e.__0=t,e.__1=u.SELECT,e},u.stringify=function(e,t){return void 0===t&&(t=0),JSON.stringify(e,e.__0.fieldNames,t)},u.INIT=0,u.INSERT=1,u.SELECT=2,u.UPDATE=3,u.DELETE=4,u}();t.dbutil=n}),define("tableinfo",["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(){}return e.prototype.setInfo=function(e,t,n){for(var i=[],r=[],o=0;o<n.length;o++)i[o]=n[o].Field,r[o]=n[o].Comment;var u=n[0].Field,l=this;l.keyName=u,l.fieldNames=i,l.fieldComments=r,l.field_db=n,l.tableName=t,l.select="select * from "+t+" where "+u+"=",l.delete="delete from "+t+" where "+u+"=";var s=i[1]+"=?";for(o=2;o<i.length;o++)s=s+","+i[o]+"=?";l.insert="insert into "+t+" set "+s,l.update="update "+t+" set "+s+" where "+u+"="},e.prototype.getid=function(e){return e[this.keyName]},e.prototype.setid=function(e,t){e[this.keyName]=t},e.prototype.p_insert=function(e){return this.p_update(e)},e.prototype.p_update=function(e){for(var t=this.fieldNames,n=[],i=t.length-1;0<i;i--)n[i-1]=e[t[i]];return n},e.prototype.s_select=function(e,t,n){var i="select * from "+this.tableName;if(e){i+=" where ";for(var r=0;r<e.length;r++){0<r&&(i+=" and ");var o=e[r];i=i+"("+o[0]+" "+o[1]+" ?)"}}return t&&(i=i+" order by "+t),n&&0<n&&(i=i+" limit "+n),i},e.prototype.a_select=function(e){var t=[];if(e)for(var n=0;n<e.length;n++)t[n]=e[n][2];return t},e}();t.tableinfo=n}),define("query",["require","exports","dbutil"],function(e,t,u){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(){}return e.prototype._sql=function(e,t,n,i){t.query(n,i,e)},e.prototype._update=function(e,t,n){if(n.__1==u.dbutil.UPDATE){var i=n.__0;this._sql(e,t,i.update+i.getid(n),i.p_update(n))}else e(n.__1+"!=update",n)},e.prototype._delete=function(e,t,n){if(n.__1==u.dbutil.DELETE){var i=n.__0;this._sql(e,t,n.__0.delete+i.getid(n),null)}else e(n.__1+"!=delete",n)},e.prototype._insert=function(n,e,i){if(i.__1==u.dbutil.INSERT){var r=i.__0;this._sql(function(e,t){e||(i[r.keyName]=t.insertId,i.__1=u.dbutil.SELECT),n(e,t)},e,r.insert,r.p_insert(i))}else n(i.__1+"!=insert",i)},e.prototype._select=function(i,e,r,t,o){this._sql(function(e,t){if(e)i(e,r);else{for(var n=0;n<t.length;n++)u.dbutil.result2Row(t[n],o);i(e,t)}},e,r,t)},e.prototype._find=function(e,t,n,i){this._select(e,t,i.select+n,null,i)},e.prototype._findMax=function(e,t,n,i,r,o){var u=n.s_select(i,r,o),l=n.a_select(i);this._select(e,t,u,l,n)},e}();t.query=n}),define("dbqueue",["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(){this.count=1,this._a=[],this._0=0}return e.prototype.add=function(e){var t=this._a;t[t.length]=e,this._next()},e.prototype._endcb=function(){var e=this._a,t=this._0;0<e.length?(e.splice(0,1),this._0=t-1,this._next()):console.error("it must no happed!")},e.prototype._next=function(){var e=this,t=e._a,n=e._0;0<t.length&&n<e.count&&(e._0=n+1,t[n](e._endcb.bind(e)))},e.prototype.size=function(){return this._a.length},e}();t.dbqueue=n}),define("db",["require","exports","tableinfo","dbutil","query","dbqueue"],function(e,t,a,_,n,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=e("mysql"),o=function(){function e(){this._0=new i.dbqueue,this._1=new i.dbqueue,this.tables={},this.escape=r.escape,this.q=new n.query}return e.prototype.destroy=function(){this.pool.end()},e.prototype.size=function(){return this._0.size()+this._1.size()},e.prototype.connect=function(u,e,t,l){void 0===l&&(l=null);var s=this;if(null==s.name){"object"!=typeof e&&(e={host:"localhost",port:3306,user:"root",password:"",database:e,charset:"UTF8_GENERAL_CI"});Date.now();var n=e.database,i=r.createPoolCluster();i.add(n,e),s.pool=i,s.conn=i.of(n),s.name=n;s._add(s._0,s,s.q._sql,[null,null,"show tables"],function(e,t){if(e)u(e);else{var r="Tables_in_"+n,o=t.length;t.forEach(function(e){var n=e[r],i=new a.tableinfo;s.tables[n]=i;var t=[null,null,"show full columns from "+n];0,s._add(s._0,s,s.q._sql,t,function(e,t){o--,_.dbutil.isKeyPRI(t[0])||l(n+" keypri is not "+t[0].field),i.setInfo(s,n,t),l&&l("read table : "+i.tableName),0==o&&u(null)})})}})}else u("It has already connect!")},e.prototype._add=function(e,t,r,o,u){e.add(function(i){t.getConnection(function(e,n){e?(u&&u(e,null),i()):(o[0]=function(e,t){n.release(),u&&u(e,t),i()},o[1]=n,r.apply(null,o))})})},e.prototype.find=function(e,t,n){var i=this,r=i._check(e,n,t,i);null!=r&&i._add(i._0,i,i.q._find.bind(i.q),[null,null,n,r],e)},e.prototype.findMax=function(e,t,n,i,r){void 0===i&&(i=null),void 0===r&&(r=0);var o=this,u=o.tables[t];null!=u?o._add(o._0,o,o.q._findMax.bind(o.q),[null,null,u,n,i,r],e):e(o.name+" has no table with name="+t,null)},e.prototype.update=function(e,t){if(t.__1!=_.dbutil.SELECT)return!1;var n=this;return t.__1=_.dbutil.UPDATE,n._add(n._1,n,n.q._update.bind(n.q),[null,null,t],e),!0},e.prototype.insert=function(e,t){if(t.__1!=_.dbutil.INIT)return!1;t.__1=_.dbutil.INSERT;var n=this;return n._add(n._1,n,n.q._insert.bind(n.q),[null,null,t],e),!0},e.prototype.delete=function(e,t){var n=t.__1;if(n==_.dbutil.INIT)return!1;if(n==_.dbutil.INSERT)t.__1=_.dbutil.INIT;else if(n!=_.dbutil.DELETE){var i=this;return t.__1=_.dbutil.DELETE,i._add(i._1,i,i.q._delete.bind(i.q),[null,null,t],e),!0}return!1},e.prototype.deleteId=function(e,t,n){var i=this,r=i._check(e,t,n,i);null!=r&&i._add(i._1,i,i.q._sql.bind(i.q),[null,null,r.delete+t,null],e)},e.prototype.sql=function(e,t,n){var i=this;i._add(i._0,i,i.q._sql.bind(i.q),[null,null,t,n],e)},e.prototype.getConnection=function(e){return this.conn.getConnection(e)},e.prototype.table=function(e){return this.tables[e]},e.prototype.newRow=function(e,t){var n=this.tables[e];return null!=n&&_.dbutil.newRow(n,t),t},e.prototype.allTables=function(){return this.tables},e.prototype._check=function(e,t,n,i){if(isNaN(t))return e("id must be number "+t,null),null;var r=i.tables[n];return null==r?(e("DB:"+i.name+" do not have a table="+n,null),null):r},e}();t.db=o});